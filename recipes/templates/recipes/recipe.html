{% load recipes %}
{% load markup %}
{% load tagging_tags %}
{% load staticmedia %}

<div class="recipe">
	<h3 class="recipe_title"><a class="recipe_title" href="{% url view_recipe id=r.id %}">{{ r.name }}</a></h3>
	<p class="byline">Added on {{ r.date_added|date:"F j Y" }} by {% ifequal r.user request.user %} <a href="{% url userpage username=r.user.username %}">you {% if not r.is_public %} <strong>(Private)</strong> {% endif %}</a>
	{% else %} 
		<a href="{% url userpage username=r.user.username %}">{% firstof r.user.get_full_name r.user.username %}</a>
	{% endifequal %}  {% ifequal r.user request.user %} <a href="{% url edit_recipe id=r.id %}">(edit recipe)</a>
		{% endifequal %} {% if request.user.is_superuser %} <a href="{% url edit_recipe id=r.id %}">(edit recipe)</a>
			{% endif %}</p>
	
	{% if r.average_rating %}
	<span class="byline">Average rating: </span><div class="recipe_rating" id="recipe_rating_{{ r.id }}"></div>
	<script type="text/javascript" charset="utf-8">
		$('#recipe_rating_{{ r.id }}').raty({
			path: "{% mediaurl 'recipes/raty_img/' %}",
			readOnly: true,
			half: true,
			start: {{ r.average_rating }},
		});
	</script>
	{% endif %}
	{% if user.is_authenticated %}
	<span class="byline" id="user_recipe_rating_{{ r.id }}_label">Your rating: </span><div class="recipe_rating" id="user_recipe_rating_{{ r.id }}"></div>
	<script type="text/javascript" charset="utf-8">
		$.ajax({
			url: "{% url get_user_recipe_rating recipe_id=r.id %}",
			success: function(data){
				$('#user_recipe_rating_{{ r.id }}').raty({
					path: "{% mediaurl 'recipes/raty_img/' %}",
					half: true,
					start: data,
					showCancel: true,
					click: function(score){
						$.ajax({
							url: "{% url save_user_recipe_rating recipe_id=r.id %}",
							data: {'score': score,},
							type: "POST",
							error: function(){
								alert("Error! Couldn't save rating.");
							},
						});
					},
				});
			},
			error: function(){
				$("#user_recipe_rating_{{ r.id }}_label").remove();
				$("#user_recipe_rating_{{ r.id }}").remove();
			},
		});
	</script>
	{% endif %}
		
	<ul class="blurb">
		{% if r.servings %}<li><strong>Yields:</strong> {{ r.servings }} servings.</li>{% endif %}
		{% if r.prep_time %}<li><strong>Preparation time:</strong> {{ r.prep_time }} minutes.</li>{% endif %}
		{% if r.cook_time %}<li><strong>Cooking time:</strong> {{ r.cook_time }} minutes.</li>{% endif %}
		{% if r.source %}<li><strong>Source:</strong> {{ r.source }}</li>{% endif %}
		{% if r.notes %}<li><strong>Notes:</strong> {{ r.notes }}</li>{% endif %}
	</ul>
	<h4>Ingredients</h4>
	<ul class="ingredients">
		{% for i in r.ingredients.all %}
			<li>{% if i.quantity %}{{ i.quantity|html_fraction|safe }} {% endif %} {% if i.max_quantity %} to {{ i.max_quantity|html_fraction|safe }} {% endif %} {% if i.unit %} {{ i.unit }} {% endif %} <a href="{% url recipe_by_ingredient ingredient=i.ingredient.name %}">{{ i.ingredient.name }}</a>{% if i.preparation %}, {{ i.preparation }} {% endif %} {% if i.optional %}<em>(optional)</em>{% endif %}</li>
		{% endfor %}
	</ul>
	<h4>Directions</h4>
	{{ r.directions|markdown }}
	{% tags_for_object r as tag_list %}
		<ul class="tags">
			{% if tag_list %}
			<li class="tags"><strong>Tags:</strong></li>
			{% endif %}
			{% for t in tag_list.all %}
			<li class="tags"><a href="{% url recipe_by_tag tag=t.name %}">{{ t.name }}</a></li>
			{% endfor %}
			{% if user.is_authenticated %}
			<!-- Add icon by Deleket (http://www.iconarchive.com/show/sleek-xp-basic-icons-by-deleket/Add-icon.html) -->
			<li class="tags"><img src="{% mediaurl 'recipes/add.png' %}" alt="Add more tags." id="add_tag_button_{{ r.id }}"></li>
			<span id="add_tag_form_{{ r.id }}" class="add_tag_form">
				<form method="POST" action="{% url add_tags_to_recipe id=r.id %}">
					<input type="text" id="input_tags" name="input_tags" />
					<input type="submit" value="Save">
				</form>
			</span>
			<script type="text/javascript" charset="utf-8">
				$('#add_tag_button_{{ r.id }}').click(function() {
					if ($('#add_tag_form_{{ r.id }}').css('visibility') == 'collapse') {
						$('#add_tag_form_{{ r.id }}').show();
						$('#add_tag_form_{{ r.id }}').css('visibility','visible');
					}
					else {
						$('#add_tag_form_{{ r.id }}').hide();
						$('#add_tag_form_{{ r.id }}').css('visibility','collapse');
					}
				});
			</script>
			{% endif %}
		</ul>
		{% if r.tools.all %}
		<ul class="tags">
			<li class="tags"><strong>Tools needed:</strong></li>
			{% for t in r.tools.all %}
			<li class="tags"><a href="{% url recipe_by_tool tool=t.name %}">{{ t.name }}</a></li>
			{% endfor %}
		</ul>
		{% endif %}
		<div class="facebook_like">
			<fb:like href="bendakai.com{% url view_recipe id=r.id %}" show_faces="false" width="450" font="arial"></fb:like>
		</div>
</div>